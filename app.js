const start_cards= [
    "B01-005",
    "B01-008",
    "B01-023",
    "B01-025",
    "B01-042",
    "B01-044",
    "B01-063",
    "B01-064",
    "B01-082",
    "B01-083",
    "B02-004",
    "B02-005",
    "B02-026",
    "B02-027",
    "B02-044",
    "B02-047",
    "B02-065",
    "B02-066",
    "B02-085",
    "B02-086",
    "B03-002",
    "B03-022",
    "B03-045",
    "B03-065",
    "B03-084",
    "B04-005",
    "B04-026",
    "B04-045",
    "B04-065",
    "B04-082",
    "B05-005",
    "B05-024",
    "B05-043",
    "B05-064",
    "B05-082",
    "B06-002",
    "B06-022",
    "B06-043",
    "B06-064",
    "B06-083",
    "B07-005",
    "B07-024",
    "B07-045",
    "B07-065",
    "B07-082",
    "B08-005",
    "B08-023",
    "B08-043",
    "B08-063",
    "B08-083",
    "B09-003",
    "B09-023",
    "B09-044",
    "B09-063",
    "B09-083",
    "B10-004",
    "B10-023",
    "B10-045",
    "B10-065",
    "B10-083",
    "B11-004",
    "B11-023",
    "B11-043",
    "B11-064",
    "B11-083",
    "B12-002",
    "B12-022",
    "B12-044",
    "B12-062",
    "B12-084",
    "B13-003",
    "B13-022",
    "B13-044",
    "B13-063",
    "B13-083",
    "B14-003",
    "B14-024",
    "B14-042",
    "B14-064",
    "B14-084",
    "B15-005",
    "B15-023",
    "B15-045",
    "B15-065",
    "B15-085",
    "B16-004",
    "B16-024",
    "B16-046",
    "B16-065",
    "B16-085",
    "B17-007",
    "B17-025",
    "B17-042",
    "B17-066",
    "B17-084",
    "B18-005",
    "B18-026",
    "B18-045",
    "B18-062",
    "B18-084",
    "B19-003",
    "B19-024",
    "B19-045",
    "B19-067",
    "B19-083",
    "B20-002",
    "B20-024",
    "B20-046",
    "B20-063",
    "B20-083",
    "B21-006",
    "B21-007",
    "B21-025",
    "B21-042",
    "B21-063",
    "B21-086",
    "B22-003",
    "B22-024",
    "B22-046",
    "B22-064",
    "B22-082",
    "B23-002",
    "B23-004",
    "B23-023",
    "B23-043",
    "B23-063",
    "B23-084",
    "B24-003",
    "B24-004",
    "B24-021",
    "B24-023",
    "B25-005",
    "B25-007",
    "B25-021",
    "B25-023",
    "B25-040",
    "B25-041",
    "B25-058",
    "B25-060",
    "B25-078",
    "B25-079",
    "B26-015",
    "B27-004",
    "B27-017",
    "B27-030",
    "B27-042",
    "B27-054",
    "B29-046",
    "B29-068",
    "B30-061",
    "B33-026",
    "B35-010",
    "B35-016",
    "B35-018",
    "B35-041",
    "B35-056",
    "B36-030",
    "B37-001",
    "B37-003",
    "B37-016",
    "B37-047",
    "B37-050",
    "B40-027",
    "B40-028",
    "B42-011",
    "B42-022",
    "B43-011",
    "B44-023",
    "B46-022",
    "B46-024",
    "B46-027",
    "B46-030",
    "B47-018",
    "B49-006",
    "B49-007",
    "B49-015",
    "B49-022",
    "B49-026",
    "B50-003",
    "B50-009",
    "B51-005",
    "B51-030",
    "B51-080",
    "E02-006",
    "E02-027",
    "E02-046",
    "E02-063",
    "E02-085",
    "E03-006",
    "E03-025",
    "E04-003",
    "E04-013",
    "E04-022",
    "E04-033",
    "E04-045",
    "E07-005",
    "E07-013",
    "E07-027",
    "E07-035",
    "E07-047",
    "E08-003",
    "E08-012",
    "E08-023",
    "E08-035",
    "E08-044",
    "E11-002",
    "E11-011",
    "E11-017",
    "E11-025",
    "E11-033",
    "E11-041",
    "E12-004",
    "E12-012",
    "E12-020",
    "E12-026",
    "E14-003",
    "E14-030",
    "E14-034",
    "E17-002",
    "E17-008",
    "E17-014",
    "E17-020",
    "E17-026",
    "E18-002",
    "E18-011",
    "E18-015",
    "E18-023",
    "E18-031",
    "E20-007",
    "E21-038",
    "E23-018",
    "E23-026",
    "E23-043",
    "E24-016",
    "E26-002",
    "E26-011",
    "E26-020",
    "E37-045",
    "E37-046",
    "E37-047",
    "E37-048",
    "E37-049",
    "E37-050",
    "E37-051",
    "E37-052",
    "E37-074",
    "E37-075",
    "E37-076",
    "E37-077",
    "E37-078",
    "E37-079",
    "E37-080",
    "E37-081",
    "E38-001",
    "E38-002",
    "E38-003",
    "E40-001",
    "E40-002",
    "E40-003",
    "E40-004",
    "E40-005",
    "E40-006",
    "E42-041",
    "E42-043",
    "E45-005",
    "E45-013",
    "E45-021",
    "E45-029",
    "E48-011",
    "E49-002",
    "E49-008",
    "E50-003",
    "E50-009",
    "E50-015",
    "E50-018",
    "E50-023",
    "E52-017",
    "E53-001",
    "E53-005",
    "E53-007",
    "E53-010",
    "IG01-016",
    "IG01-020",
    "IG02-019",
    "IG04-010",
    "IG04-013",
    "IG06-002",
    "IG06-005",
    "IG06-008",
    "IG06-011",
    "IG06-014",
    "IG07-001",
    "IG07-077",
    "G08-012",
    "G09-007",
    "G10-004",
    "G11-003",
    "G12-008",
    "G13-002",
    "G13-004",
    "G13-006",
    "G13-008",
    "G13-010",
    "G13-012",
    "G13-014",
    "G13-016",
    "G13-018",
    "G13-020",
    "G13-022",
    "G13-024",
    "G13-026",
    "G13-028",
    "G13-030",
    "G13-032",
    "G13-034",
    "G13-036",
    "G13-038",
    "G13-040",
    "G13-042",
    "G13-044",
    "G13-046",
    "G13-048",
    "G13-050",
    "G13-053",
    "G13-056",
    "G13-059",
    "G13-062",
    "G13-065",
    "G13-068",
    "G13-071",
    "G13-074",
    "G13-077",
    "G14-007",
    "G15-009",
    "G16-002",
    "G16-029",
    "G17-011",
    "G18-007",
    "G19-006",
    "G21-003",
    "G21-025",
    "G22-007",
    "G23-001",
    "G23-013",
    "G24-008",
    "G25-009",
    "G26-009",
    "G27-015",
    "G28-010",
    "G29-008",
    "G31-005",
    "G33-004",
    "G34-007",
    "G35-008",
    "G37-006",
    "G38-020",
    "G39-011",
    "G39-031",
    "G41-006",
    "G43-007",
    "G43-031",
    "PR04-001",
    "PR04-004",
    "PR04-007",
    "PR04-010",
    "SD01-005",
    "SD02-007",
    "SD03-007",
    "SD04-009",
    "SD05-006",
    "SD06-013",
    "SD07-004",
    "SD08-004",
    "SD09-008",
    "P10-004",
    "P10-005",
    "P10-006",
    "P10-007",
    "P10-008",
    "P27-014",
    "P27-016",
    "P27-017",
    "P31-017",
    "P31-018",
    "P31-019",
    "P31-020",
    "P31-021",
    "P32-046",
    "P37-018",
    "P37-020",
    "P37-022",
    "P39-020",
    "P39-048",
    "P40-032",
    "P40-064",
    "P40-065",
    "P40-066",
    "P41-020",
    "P42-022",
    "P43-016",
    "P47-094",
    "P47-095",
    "P47-096",
    "P47-097",
    "P47-098",
    "P47-099",
    "P47-100",
    "P47-101",
    "P47-102",
    "P47-103",
    "P47-104",
    "P47-105",
    "P47-106",
    "P47-107",
    "P47-108",
    "P47-109",
    "P47-110",
    "P47-111",
    "P47-112",
    "P47-113",
    "P47-114",
    "P47-115",
    "P47-116",
    "P47-117",
    "P48-009",
    "P48-010",
    "P48-011",
    "P48-012",
    "P48-013",
    "P49-009",
    "P49-010",
    "P49-011",
    "P49-012",
    "P49-013",
    "C01-004",
    "C02-003",
    "C03-004",
    "C04-004",
    "C05-008",
    "C05-021",
    "C06-006",
    "C06-020",
    "C07-007",
    "C07-020",
    "C08-006",
    "C09-006",
    "C10-005",
    "C11-016",
    "C12-015",
    "C13-013",
    "C14-012",
    "C15-010",
    "C16-013",
    "C17-006",
    "C18-012"
]

const start_resources = [
    "B40-001",
    "B40-002",
    "B40-003",
    "B40-004",
    "B40-005",
    "B40-006",
    "B40-007",
    "B40-008",
    "B40-009",
    "B40-010",
    "B40-011",
    "B40-012",
    "B40-013",
    "B40-014",
    "B41-001",
    "B41-002",
    "B41-003",
    "B41-004",
    "B41-005",
    "B41-006",
    "B41-007",
    "B41-008",
    "B41-009",
    "B41-010",
    "B41-011",
    "B41-012",
    "B41-013",
    "B41-014",
    "B44-016",
    "B48-025",
    "B48-028",
    "B48-031",
    "B49-003",
    "B49-013",
    "B50-012",
    "B50-019",
    "B50-026",
    "E33-001",
    "E33-003",
    "E33-005",
    "E33-007",
    "E33-009",
    "E33-011",
    "E33-013",
    "E33-015",
    "E34-001",
    "E34-002",
    "E34-003",
    "E34-004",
    "E34-005",
    "E34-006",
    "E34-007",
    "E34-008",
    "E38-004",
    "E39-001",
    "E39-002",
    "E39-003",
    "E39-004",
    "E39-005",
    "E39-006",
    "E39-066",
    "E39-067",
    "E39-068",
    "E39-069",
    "E39-070",
    "E39-071",
    "E44-005",
    "E44-009",
    "E44-013",
    "E44-019",
    "E44-112",
    "E44-116",
    "E44-120",
    "E44-124",
    "E46-012",
    "E46-016",
    "E48-016",
    "E50-049",
    "E50-052",
    "E50-055",
    "E50-058",
    "E50-061",
    "E51-013",
    "E52-018",
    "E53-003",
    "E53-009",
    "IG01-001",
    "IG01-002",
    "IG01-003",
    "IG01-004",
    "IG01-005",
    "IG01-006",
    "IG01-007",
    "IG01-008",
    "IG02-002",
    "IG02-004",
    "IG02-005",
    "IG02-008",
    "IG02-010",
    "IG02-012",
    "IG02-014",
    "IG03-001",
    "IG03-002",
    "IG03-003",
    "IG03-004",
    "IG03-005",
    "IG03-006",
    "IG03-007",
    "IG03-008",
    "IG03-009",
    "IG04-001",
    "IG04-002",
    "IG04-003",
    "IG04-004",
    "IG04-005",
    "IG04-006",
    "IG04-007",
    "IG04-008",
    "IG05-001",
    "IG05-002",
    "IG05-003",
    "IG05-004",
    "IG05-005",
    "IG05-006",
    "IG05-007",
    "IG05-008",
    "IG06-001",
    "IG06-004",
    "IG06-007",
    "IG06-010",
    "IG06-013",
    "G15-016",
    "G18-004",
    "G19-018",
    "G22-005",
    "G22-034",
    "G24-005",
    "G24-031",
    "G25-005",
    "G25-034",
    "G26-016",
    "G26-032",
    "G28-004",
    "G29-004",
    "G31-017",
    "G33-016",
    "G34-014",
    "G35-003",
    "G39-016",
    "G41-013",
    "G41-035",
    "G43-013",
    "G43-034",
    "PR02-011",
    "PR02-012",
    "PR02-013",
    "PR03-014",
    "PR03-015",
    "PR03-018",
    "PR03-019",
    "PR05-016",
    "SD07-013",
    "SD08-009",
    "SD08-035",
    "SD09-016",
    "SD09-035",
    "P40-004",
    "P40-005",
    "P40-006",
    "P40-007",
    "P40-008",
    "P40-009",
    "P40-036",
    "P41-004",
    "P41-005",
    "P41-006",
    "P41-007",
    "P41-008",
    "P41-009",
    "P41-026",
    "P41-053",
    "P42-028",
    "P42-054",
    "P43-025",
    "P43-036",
    "P43-037",
    "P43-038",
    "P43-039",
    "P43-040",
    "P44-046",
    "P44-047",
    "P44-049",
    "P44-050",
    "P44-051",
    "P44-053",
    "P44-054",
    "P44-055",
    "P44-058"
]
const gate_cards = [
    "B32-010",
    "B32-011",
    "B32-021",
    "B32-022",
    "B32-033",
    "B32-034",
    "B32-047",
    "B32-048",
    "B32-049",
    "B32-059",
    "B32-060",
    "B33-007",
    "B33-018",
    "B33-019",
    "B33-020",
    "B33-033",
    "B33-034",
    "B33-044",
    "B33-045",
    "B33-056",
    "B33-057",
    "B33-062",
    "B35-108",
    "B36-062",
    "B37-062",
    "B38-031",
    "B42-006",
    "B42-067",
    "B51-024",
    "E21-006",
    "E21-012",
    "E21-018",
    "E21-024",
    "E21-030",
    "E21-036",
    "E22-007",
    "E22-014",
    "E22-021",
    "E22-028",
    "E22-035",
    "E23-005",
    "E23-009",
    "E23-015",
    "E24-007",
    "E24-014",
    "E24-021",
    "E24-028",
    "E24-035",
    "E25-082",
    "E25-083",
    "E25-084",
    "E25-085",
    "E25-086",
    "E25-087",
    "E26-009",
    "E26-018",
    "E26-027",
    "E34-045",
    "E34-046",
    "E34-047",
    "E34-048",
    "E34-049",
    "E34-050",
    "E35-003",
    "E35-012",
    "E35-020",
    "E35-115",
    "E35-123",
    "E35-130",
    "E37-065",
    "E39-011",
    "E40-065",
    "E42-024",
    "E42-125",
    "E46-014",
    "E47-003",
    "E47-084",
    "E48-054",
    "E48-086",
    "E48-100",
    "E48-102",
    "E49-053",
    "E49-074",
    "E49-095",
    "E49-098",
    "E50-005",
    "E53-059",
    "E53-060",
    "IG02-059",
    "IG04-015",
    "IG06-088",
    "IG06-090",
    "IG07-056",
    "IG07-058",
    "IG07-078",
    "G07-003",
    "G07-010",
    "G09-015",
    "G10-016",
    "G12-017",
    "G14-015",
    "G15-020",
    "G16-011",
    "G22-017",
    "G24-015",
    "G25-014",
    "G37-017",
    "G38-032",
    "G39-018",
    "G40-069",
    "G41-016",
    "SD05-014",
    "SD06-007",
    "SD07-015",
    "SD08-016",
    "P32-005",
    "P32-006",
    "P32-007",
    "P32-008",
    "P32-009",
    "P32-010",
    "P32-054",
    "P33-005",
    "P33-006",
    "P33-007",
    "P33-008",
    "P33-009",
    "P33-010",
    "P34-015",
    "P34-016",
    "P34-017",
    "P34-018",
    "P34-019",
    "P34-027",
    "P36-037",
    "P37-019",
    "P37-021",
    "P37-023",
    "P39-027",
    "P39-043",
    "P40-039",
    "P41-029",
    "P42-032",
    "P44-088",
    "P48-029"
]

const log = (msg) => {
  document.getElementById("log").textContent += msg + "\n";
};

async function fetchCard(cardId) {
  const [set, num] = cardId.split("-");
  const url = `cards/${set}/${num}.json`;

  const res = await fetch(url);
  if (!res.ok) {
    throw new Error(`Failed to fetch ${cardId}`);
  }
  return await res.json();
}

const CORS_PROXY = "https://api.allorigins.win/raw?url=";
// const CORS_PROXY = ""
async function fetchDeckPage(url) {
  const res = await fetch(CORS_PROXY + encodeURIComponent(url));
  if (!res.ok) {
    throw new Error("Failed to fetch deck page");
  }
  return await res.text();
}

function parseDeckFromHTML(htmlText) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(htmlText, "text/html");

  const startCardDeck = []
  const startResourceDeck = []
  const gateCardDeck = []
  function extract(articleId) {
    const article = doc.querySelector(`article#${articleId}`);
    if (!article) return [];

    return Array.from(article.querySelectorAll("section")).map(sec => {
      const cardNo = sec.querySelector(".cardno")?.textContent.trim();
      const countText = sec.querySelector(".counter")?.textContent.trim();
      if (!cardNo) return null;
      let count = Number(countText || "1")
      // if (!countText) return null;
      if(start_cards.includes(cardNo)){
        startCardDeck.push({cardNo, count: 1})
        count = count - 1
        console.log("start card")
        if(count == 0) return null
      }
      if(start_resources.includes(cardNo)){
        startResourceDeck.push({cardNo, count: 1})
        count = count - 1
        console.log("start resource")
        if(count == 0) return null
      }
      if(gate_cards.includes(cardNo)){
        gateCardDeck.push({cardNo, count: 1})
        count = count - 1
        console.log("gate card")
        if(count == 0) return null
      }

      return {
        cardNo,
        count
      };
    }).filter(Boolean);
  }

  return {
    "プレイヤーカード": extract("PlayerCard"),
    "基本デッキ": extract("BaseDeck"),
    "デュナミスデッキ": extract("DuDeck"),
    "ゲートカード": gateCardDeck,
    "スタートリソース": startResourceDeck,
    "スタートカード": startCardDeck,
    "その他": extract("EtcDeck"),
  };
}

function formatDeck(deck) {
  function formatSection(title, cards) {
    if (!cards.length) return `${title}\n`;
    return (
      title + "\n" +
      cards.map(c => `${c.cardNo} ${c.count}`).join("\n") +
      "\n"
    );
  }
  const deckStrs = []
  for(const [key, value] of Object.entries(deck)) {
    deckStrs.push(formatSection(`#${key}`, value))
  }
  return deckStrs.join("\n")

  // return [
  //   formatSection("#プレイヤーカード", deck["プレイヤーカード"]),
  //   formatSection("#基本デッキ", deck["基本デッキ"]),
  //   formatSection("#デュナミスデッキ", deck["デュナミスデッキ"]),
  //   formatSection("#その他", deck["その他"]),
  // ].join("\n");
}

document.getElementById("importDeckBtn").onclick = async () => {
  const url = document.getElementById("deckUrl").value.trim();
  const output = document.getElementById("deckOutput");
  output.textContent = "";

  if (!url.includes("deck_public_view.php")) {
    output.textContent = "Invalid deck URL";
    return;
  }

  try {
    output.textContent = "Fetching deck...\n";
    const html = await fetchDeckPage(url);
    const deck = parseDeckFromHTML(html);
    // console.log(deck)
    // console.log(deck["プレイヤーカード"])
    const formatted = formatDeck(deck);
    output.textContent = formatted;
    // console.log(output.textContent)
  } catch (e) {
    output.textContent = "ERROR: " + e.message;
    throw(e)
  }
};
